AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Complens.ai - AI-Native Marketing Automation Platform

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Deployment stage

  DomainName:
    Type: String
    Default: "dev.complens.ai"
    Description: Base domain name for the API

  HostedZoneId:
    Type: String
    Default: "Z02373573N3XBHSZBERY6"
    Description: Route 53 hosted zone ID for the domain

  EnableCustomDomain:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: Enable custom domain configuration (requires valid hosted zone)

  CertificateArn:
    Type: String
    Default: ""
    Description: Optional existing ACM certificate ARN. If empty, a new certificate will be created.

  # Integration Parameters
  TwilioAccountSid:
    Type: String
    Default: ""
    Description: Twilio Account SID for SMS integration

  TwilioAuthToken:
    Type: String
    Default: ""
    NoEcho: true
    Description: Twilio Auth Token for SMS integration

  TwilioPhoneNumber:
    Type: String
    Default: ""
    Description: Default Twilio phone number for sending SMS

  SesFromEmail:
    Type: String
    Default: ""
    Description: Default sender email address for SES

  SegmentSharedSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: Segment webhook shared secret for signature verification

  # Stripe Connect parameters
  StripeSecretKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Stripe secret API key

  StripePublishableKey:
    Type: String
    Default: ""
    Description: Stripe publishable API key

  StripeWebhookSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: Stripe webhook signing secret

  StripeConnectClientId:
    Type: String
    Default: ""
    Description: Stripe Connect OAuth client ID

  StripePlatformFeePercent:
    Type: String
    Default: "0.02"
    Description: Platform fee percentage (0.02 = 2%)

  # Platform Billing Parameters
  StripeBillingSecretKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Stripe secret key for platform billing (same account as Connect)

  StripeEventSourceName:
    Type: String
    Default: ""
    Description: "Stripe EventBridge partner event source name (e.g., aws.partner/stripe.com/ed_xxx)"

  StripeProPriceId:
    Type: String
    Default: "price_1Sww6Y8Z757t07Q3y7AseKJJ"
    Description: Stripe Price ID for Pro plan

  StripeBusinessPriceId:
    Type: String
    Default: "price_1Sww6Z8Z757t07Q3Nzw5zczq"
    Description: Stripe Price ID for Business plan

  # Knowledge Base Parameters
  KnowledgeBaseId:
    Type: String
    Default: ""
    Description: Bedrock Knowledge Base ID

  KBDataSourceId:
    Type: String
    Default: ""
    Description: Bedrock Knowledge Base Data Source ID

Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    MemorySize: 256
    Tracing: Active
    Architectures:
      - x86_64
    Environment:
      Variables:
        TABLE_NAME: !Ref MainTable
        STAGE: !Ref Stage
        SERVICE_NAME: complens
        COGNITO_USER_POOL_ID: !Ref UserPool
        AI_QUEUE_URL: !Ref AIProcessingQueue
        WORKFLOW_QUEUE_URL: !Ref WorkflowQueue
        EVENT_BUS_NAME: !Ref WorkflowEventBus
        # Sharded queue configuration
        SHARD_QUEUE_URL_0: !Ref WorkflowQueueShard0
        SHARD_QUEUE_URL_1: !Ref WorkflowQueueShard1
        SHARD_QUEUE_URL_2: !Ref WorkflowQueueShard2
        SHARD_QUEUE_URL_3: !Ref WorkflowQueueShard3
        PRIORITY_QUEUE_URL: !Ref WorkflowPriorityQueue
        SHARD_COUNT: "4"
        # DLQ alert configuration
        DLQ_ALERT_TOPIC_ARN: !Ref DLQAlertTopic
        # Express State Machine for fast workflows
        WORKFLOW_EXPRESS_STATE_MACHINE_ARN: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor-express"
        WEBSOCKET_ENDPOINT: !If [CustomDomainEnabled, !Sub "wss://ws.${DomainName}", !Sub "wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"]
        # CORS configuration - restrict to frontend origin
        CORS_ALLOWED_ORIGIN: !If
          - IsProd
          - "https://complens.ai"
          - !Sub "https://${DomainName}"
        # Integration settings
        TWILIO_ACCOUNT_SID: !Ref TwilioAccountSid
        TWILIO_AUTH_TOKEN: !Ref TwilioAuthToken
        TWILIO_PHONE_NUMBER: !Ref TwilioPhoneNumber
        SES_FROM_EMAIL: !Ref SesFromEmail
        SEGMENT_SHARED_SECRET: !Ref SegmentSharedSecret
        # Stripe settings
        STRIPE_SECRET_KEY: !Ref StripeSecretKey
        STRIPE_PUBLISHABLE_KEY: !Ref StripePublishableKey
        STRIPE_WEBHOOK_SECRET: !Ref StripeWebhookSecret
        STRIPE_CONNECT_CLIENT_ID: !Ref StripeConnectClientId
        STRIPE_PLATFORM_FEE_PERCENT: !Ref StripePlatformFeePercent
    Layers:
      - !Ref SharedLayer

Resources:
  # ============================================
  # DynamoDB Table - Single Table Design
  # ============================================
  MainTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "complens-${Stage}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # WebSocket Connections Table
  ConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "complens-${Stage}-connections"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: connectionId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: workspaceId
          AttributeType: S
      KeySchema:
        - AttributeName: connectionId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: WorkspaceIdIndex
          KeySchema:
            - AttributeName: workspaceId
              KeyType: HASH
            - AttributeName: connectionId
              KeyType: RANGE
          Projection:
            ProjectionType: KEYS_ONLY
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # ============================================
  # Cognito User Pool
  # ============================================
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "complens-${Stage}-users"
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      MfaConfiguration: OPTIONAL
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      Schema:
        - Name: agency_id
          AttributeDataType: String
          Mutable: true
        - Name: workspace_ids
          AttributeDataType: String
          Mutable: true
        - Name: is_super_admin
          AttributeDataType: String
          Mutable: true
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      UserPoolTags:
        Service: complens
        Stage: !Ref Stage

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "complens-${Stage}-web"
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
      PreventUserExistenceErrors: ENABLED
      AccessTokenValidity: 1
      IdTokenValidity: 1
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      SupportedIdentityProviders:
        - COGNITO

  # ============================================
  # SQS Queues
  # ============================================
  AIProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 120
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AIDeadLetterQueue.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  AIDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # FIFO Queue for fair multi-tenant workflow processing
  WorkflowQueue:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      ContentBasedDeduplication: true
      DeduplicationScope: messageGroup
      FifoThroughputLimit: perMessageGroupId
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt WorkflowDeadLetterQueue.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  WorkflowDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      ContentBasedDeduplication: false
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 300  # Must be >= Lambda timeout (120s)
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # ============================================
  # Sharded Queues for Scalable Workflow Processing
  # ============================================
  # These standard SQS queues replace the FIFO queue for unlimited throughput.
  # Workspaces are routed to shards using consistent hashing.

  # Shared DLQ for all sharded queues
  ShardedWorkflowDLQ:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 300
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # Shard 0
  WorkflowQueueShard0:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ShardedWorkflowDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage
        - Key: ShardIndex
          Value: "0"

  # Shard 1
  WorkflowQueueShard1:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ShardedWorkflowDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage
        - Key: ShardIndex
          Value: "1"

  # Shard 2
  WorkflowQueueShard2:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ShardedWorkflowDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage
        - Key: ShardIndex
          Value: "2"

  # Shard 3
  WorkflowQueueShard3:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ShardedWorkflowDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage
        - Key: ShardIndex
          Value: "3"

  # Priority Queue for time-sensitive workflows
  WorkflowPriorityQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 120
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ShardedWorkflowDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # ============================================
  # SNS Topic for DLQ Alerts
  # ============================================
  DLQAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: "Complens DLQ Alerts"
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # ============================================
  # EventBridge - Event Routing
  # ============================================
  WorkflowEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub "${AWS::StackName}-workflow-events"
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # Rule for tag-based triggers
  TagTriggerRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref WorkflowEventBus
      EventPattern:
        source:
          - "complens.contact"
        detail-type:
          - "contact.tag.added"
          - "contact.tag.removed"
      State: ENABLED
      Targets:
        - Id: WorkflowTriggerQueue
          Arn: !GetAtt WorkflowQueue.Arn
          SqsParameters:
            MessageGroupId: "workflow-triggers"

  # Rule for form submission triggers
  FormSubmitRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref WorkflowEventBus
      EventPattern:
        source:
          - "complens.form"
        detail-type:
          - "form.submitted"
      State: ENABLED
      Targets:
        - Id: WorkflowTriggerQueue
          Arn: !GetAtt WorkflowQueue.Arn
          SqsParameters:
            MessageGroupId: "workflow-triggers"

  # Rule for inbound message triggers
  InboundMessageRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref WorkflowEventBus
      EventPattern:
        source:
          - "complens.messaging"
        detail-type:
          - "sms.inbound"
          - "email.inbound"
      State: ENABLED
      Targets:
        - Id: WorkflowTriggerQueue
          Arn: !GetAtt WorkflowQueue.Arn
          SqsParameters:
            MessageGroupId: "workflow-triggers"

  # Permission for EventBridge to send to SQS
  WorkflowQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref WorkflowQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt WorkflowQueue.Arn
            Condition:
              ArnEquals:
                "aws:SourceArn":
                  - !GetAtt TagTriggerRule.Arn
                  - !GetAtt FormSubmitRule.Arn
                  - !GetAtt InboundMessageRule.Arn

  # ============================================
  # Lambda Layer
  # ============================================
  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: Shared code for Complens Lambda functions
      ContentUri: src/layers/shared/
      CompatibleRuntimes:
        - python3.12
      CompatibleArchitectures:
        - x86_64
      RetentionPolicy: Retain

  # ============================================
  # REST API Gateway
  # ============================================
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      TracingEnabled: true
      Cors:
        AllowMethods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token,X-Requested-With'"
        AllowOrigin: !If
          - IsProd
          - "'https://complens.ai'"
          - !Sub "'https://${DomainName}'"
        AllowCredentials: true
        MaxAge: "'600'"
      Auth:
        DefaultAuthorizer: JwtAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          JwtAuthorizer:
            FunctionArn: !GetAtt JwtAuthorizerFunction.Arn
            FunctionPayloadType: REQUEST
            Identity:
              Headers:
                - Authorization
              ReauthorizeEvery: 300
      GatewayResponses:
        DEFAULT_4XX:
          StatusCode: 400
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !If
                - IsProd
                - "'https://complens.ai'"
                - !Sub "'https://${DomainName}'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
              Access-Control-Allow-Credentials: "'true'"
          ResponseTemplates:
            application/json: '{"message": "$context.error.messageString"}'
        DEFAULT_5XX:
          StatusCode: 500
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !If
                - IsProd
                - "'https://complens.ai'"
                - !Sub "'https://${DomainName}'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
              Access-Control-Allow-Credentials: "'true'"
          ResponseTemplates:
            application/json: '{"message": "Internal server error"}'
        UNAUTHORIZED:
          StatusCode: 401
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !If
                - IsProd
                - "'https://complens.ai'"
                - !Sub "'https://${DomainName}'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
              Access-Control-Allow-Credentials: "'true'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
          ResponseTemplates:
            application/json: '{"message": "Unauthorized"}'
        ACCESS_DENIED:
          StatusCode: 403
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !If
                - IsProd
                - "'https://complens.ai'"
                - !Sub "'https://${DomainName}'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
          ResponseTemplates:
            application/json: '{"message": "Access denied"}'
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          ThrottlingBurstLimit: !If [IsProd, 200, 50]
          ThrottlingRateLimit: !If [IsProd, 100, 25]
          MetricsEnabled: true

  # ============================================
  # WebSocket API
  # ============================================
  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${AWS::StackName}-websocket"
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"
      Tags:
        Service: complens
        Stage: !Ref Stage

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref WebSocketApi
      StageName: !Ref Stage
      AutoDeploy: true

  WebSocketConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      OperationName: Connect
      Target: !Sub "integrations/${WebSocketConnectIntegration}"

  WebSocketConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations"

  WebSocketDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      OperationName: Disconnect
      Target: !Sub "integrations/${WebSocketDisconnectIntegration}"

  WebSocketDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations"

  WebSocketMessageRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: message
      AuthorizationType: NONE
      OperationName: Message
      Target: !Sub "integrations/${WebSocketMessageIntegration}"

  WebSocketMessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketMessageFunction.Arn}/invocations"

  # Default route catches all other actions (like public_chat)
  WebSocketDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $default
      AuthorizationType: NONE
      OperationName: Default
      Target: !Sub "integrations/${WebSocketMessageIntegration}"

  # ============================================
  # Lambda Functions - Authorizer
  # ============================================
  JwtAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: jwt_authorizer.handler
      CodeUri: src/handlers/authorizer/
      Description: JWT token validation for API Gateway
      Environment:
        Variables:
          COGNITO_USER_POOL_ID: !Ref UserPool
          COGNITO_REGION: !Ref AWS::Region
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:GetUser
              Resource: !GetAtt UserPool.Arn

  JwtAuthorizerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref JwtAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*"

  # ============================================
  # Lambda Functions - API Handlers
  # ============================================
  WorkspacesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: workspaces.handler
      CodeUri: src/handlers/api/
      Description: Workspaces CRUD operations
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}
            Method: DELETE
        GetIntegrations:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/integrations
            Method: GET
        SaveTwilio:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/integrations/twilio
            Method: PUT
        SaveSegment:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/integrations/segment
            Method: PUT
        TestTwilio:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/integrations/twilio/test
            Method: POST
        DisconnectTwilio:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/integrations/twilio
            Method: DELETE
        DisconnectSegment:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/integrations/segment
            Method: DELETE

  TeamFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: team.handler
      CodeUri: src/handlers/api/
      Description: Team management and invitations
      Environment:
        Variables:
          COGNITO_USER_POOL_ID: !Ref UserPool
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AdminGetUser
                - cognito-idp:AdminUpdateUserAttributes
              Resource: !GetAtt UserPool.Arn
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*"
      Events:
        ListTeam:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/team
            Method: GET
        InviteMember:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/team/invite
            Method: POST
        UpdateMember:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/team/{user_id}
            Method: PUT
        RemoveMember:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/team/{user_id}
            Method: DELETE
        RevokeInvitation:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/team/invitations/{email}
            Method: DELETE
        AcceptInvitation:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /team/accept-invite
            Method: POST

  ContactsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: contacts.handler
      CodeUri: src/handlers/api/
      Description: Contacts CRUD operations
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}
            Method: DELETE
        GetActivity:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/activity
            Method: GET
        ListNotes:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/notes
            Method: GET
        CreateNote:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/notes
            Method: POST
        UpdateNote:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/notes/{note_id}
            Method: PUT
        DeleteNote:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/notes/{note_id}
            Method: DELETE
        Import:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/import
            Method: POST
        Export:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/export
            Method: GET

  ConversationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: conversations.handler
      CodeUri: src/handlers/api/
      Description: Conversations CRUD operations
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        ListByWorkspace:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/conversations
            Method: GET
        ListByContact:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/conversations
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/conversations
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /conversations/{conversation_id}
            Method: GET

  MessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: messages.handler
      CodeUri: src/handlers/api/
      Description: Messages CRUD operations
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt AIProcessingQueue.QueueName
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /conversations/{conversation_id}/messages
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /conversations/{conversation_id}/messages
            Method: POST

  WorkflowsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: workflows.handler
      CodeUri: src/handlers/api/
      Description: Workflows CRUD and execution
      Timeout: 60
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueue.QueueName
        - StepFunctionsExecutionPolicy:
            StateMachineName: !GetAtt WorkflowExecutorStateMachine.Name
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}
            Method: DELETE
        Execute:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}/execute
            Method: POST
        Runs:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}/runs
            Method: GET
        TestEmail:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}/test-email
            Method: POST

  PagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: pages.handler
      CodeUri: src/handlers/api/
      Description: Pages CRUD operations with AI generation
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          ASSETS_BUCKET: !Ref AssetsBucket
          # Distribution IDs are fetched from SSM at runtime or left empty
          # They will be populated after deployment via a custom resource or manually
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3CrudPolicy:
            BucketName: !Ref AssetsBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource:
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0"
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-haiku-4-5-20251001-v1:0"
                - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-image-generator-v2:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-sonnet-4-5-20250929-v1:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-haiku-4-5-20251001-v1:0"
        - Statement:
            - Effect: Allow
              Action:
                - cloudfront:CreateInvalidation
              Resource: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/*"
        - Statement:
            - Effect: Allow
              Action:
                - cloudformation:DescribeStacks
              Resource: !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/complens-${Stage}/*"
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages
            Method: POST
        Generate:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/generate
            Method: POST
        CheckSubdomain:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/check-subdomain
            Method: GET
        CreateComplete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/create-complete
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}
            Method: DELETE
        # Nested Forms endpoints (forms belong to pages)
        PageFormsList:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/forms
            Method: GET
        PageFormsCreate:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/forms
            Method: POST
        PageFormsGet:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/forms/{form_id}
            Method: GET
        PageFormsUpdate:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/forms/{form_id}
            Method: PUT
        PageFormsDelete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/forms/{form_id}
            Method: DELETE
        # Nested Workflows endpoints (page-specific workflows)
        PageWorkflowsList:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/workflows
            Method: GET
        PageWorkflowsCreate:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/workflows
            Method: POST
        PageWorkflowsGet:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/workflows/{workflow_id}
            Method: GET
        PageWorkflowsUpdate:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/workflows/{workflow_id}
            Method: PUT
        PageWorkflowsDelete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}/workflows/{workflow_id}
            Method: DELETE

  FormsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: forms.handler
      CodeUri: src/handlers/api/
      Description: Forms CRUD operations
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/forms
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/forms
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}
            Method: DELETE
        Submissions:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}/submissions
            Method: GET

  # ============================================
  # AI Service (Business Profile, Content Generation, Image Generation)
  # ============================================
  AIFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: ai.handler
      CodeUri: src/handlers/api/
      Description: AI-powered content generation and business profile management
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          ASSETS_BUCKET: !Ref AssetsBucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3CrudPolicy:
            BucketName: !Ref AssetsBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource:
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0"
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-haiku-4-5-20251001-v1:0"
                - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-image-generator-v2:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-sonnet-4-5-20250929-v1:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-haiku-4-5-20251001-v1:0"
      Events:
        # Business Profile
        GetProfile:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/profile
            Method: GET
        UpdateProfile:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/profile
            Method: PUT
        AnalyzeContent:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/profile/analyze
            Method: POST
        # AI Onboarding
        OnboardingQuestion:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/onboarding/question
            Method: GET
        OnboardingAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/onboarding/answer
            Method: POST
        # AI Generation
        ImproveBlock:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/improve-block
            Method: POST
        GenerateBlocks:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/generate-blocks
            Method: POST
        GenerateImage:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/generate-image
            Method: POST
        GenerateWorkflow:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/generate-workflow
            Method: POST
        GeneratePageContent:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/generate-page-content
            Method: POST
        RefinePageContent:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/refine-page-content
            Method: POST
        SynthesizePlan:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/synthesize-page/plan
            Method: POST
        SynthesizeGenerate:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/synthesize-page/generate
            Method: POST
        SynthesizePage:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/ai/synthesize-page
            Method: POST

  # ============================================
  # Custom Domain Management
  # ============================================
  DomainsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: domains.handler
      CodeUri: src/handlers/api/
      Description: Custom domain management
      Timeout: 60
      Environment:
        Variables:
          MAX_DOMAINS_PER_WORKSPACE: "1"
          DOMAIN_PROVISIONING_STATE_MACHINE_ARN: !If [CustomDomainEnabled, !Ref DomainProvisioningStateMachine, ""]
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - acm:DescribeCertificate
                - acm:DeleteCertificate
                - acm:AddTagsToCertificate
              Resource: !Sub "arn:aws:acm:${AWS::Region}:${AWS::AccountId}:certificate/*"
            - Effect: Allow
              Action:
                - acm:RequestCertificate
              Resource: "*"
            - Effect: Allow
              Action:
                - cloudfront:GetDistribution
                - cloudfront:UpdateDistribution
              Resource: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/*"
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !If [CustomDomainEnabled, !Ref DomainProvisioningStateMachine, !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:*"]
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/domains
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/domains
            Method: POST
        GetStatus:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/domains/{domain}
            Method: GET
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/domains/{domain}
            Method: DELETE

  DomainProvisionerFunction:
    Type: AWS::Serverless::Function
    Condition: CustomDomainEnabled
    Properties:
      Handler: domain_provisioner.handler
      CodeUri: src/handlers/workers/
      Description: Domain provisioning worker for Step Functions
      Timeout: 120
      Environment:
        Variables:
          API_GATEWAY_DOMAIN: !Sub "api.${DomainName}"
          STAGE: !Ref Stage
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - acm:DescribeCertificate
              Resource: !Sub "arn:aws:acm:${AWS::Region}:${AWS::AccountId}:certificate/*"
            - Effect: Allow
              Action:
                - cloudfront:GetDistribution
                - cloudfront:UpdateDistribution
                - cloudfront:DeleteDistribution
                - cloudfront:TagResource
              Resource: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/*"
            - Effect: Allow
              Action:
                - cloudfront:CreateDistribution
              Resource: "*"

  DomainProvisioningStateMachine:
    Type: AWS::Serverless::StateMachine
    Condition: CustomDomainEnabled
    Properties:
      Name: !Sub "complens-${Stage}-domain-provisioning"
      DefinitionUri: step-functions/domain-provisioning.asl.json
      DefinitionSubstitutions:
        DomainProvisionerFunctionArn: !GetAtt DomainProvisionerFunction.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref DomainProvisionerFunction
      Tags:
        Service: complens
        Stage: !Ref Stage

  PublicPagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: public_pages.handler
      CodeUri: src/handlers/api/
      Description: Public pages and form submissions (no auth)
      Environment:
        Variables:
          DOMAIN_NAME: !Ref DomainName
          WORKFLOW_QUEUE_URL: !Ref WorkflowQueue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt WorkflowEventBus.Arn
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt WorkflowQueue.Arn
      Events:
        GetPage:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/pages/{slug}
            Method: GET
            Auth:
              Authorizer: NONE
        GetForm:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/forms/{form_id}
            Method: GET
            Auth:
              Authorizer: NONE
        SubmitPageForm:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/submit/page/{page_id}
            Method: POST
            Auth:
              Authorizer: NONE
        SubmitPageFormOptions:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/submit/page/{page_id}
            Method: OPTIONS
            Auth:
              Authorizer: NONE
        SubmitForm:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/submit/form/{form_id}
            Method: POST
            Auth:
              Authorizer: NONE
        SubmitFormOptions:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/submit/form/{form_id}
            Method: OPTIONS
            Auth:
              Authorizer: NONE
        GetChatConfig:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/chat-config/{page_id}
            Method: GET
            Auth:
              Authorizer: NONE
        GetChatConfigOptions:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/chat-config/{page_id}
            Method: OPTIONS
            Auth:
              Authorizer: NONE
        GetPageByDomain:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/domain/{domain}
            Method: GET
            Auth:
              Authorizer: NONE
        GetPageBySubdomain:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /public/subdomain/{subdomain}
            Method: GET
            Auth:
              Authorizer: NONE

  # ============================================
  # Lambda Functions - WebSocket
  # ============================================
  WebSocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: connect.handler
      CodeUri: src/handlers/websocket/
      Description: WebSocket connection handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable

  WebSocketConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebSocketConnectFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

  WebSocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: disconnect.handler
      CodeUri: src/handlers/websocket/
      Description: WebSocket disconnection handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable

  WebSocketDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebSocketDisconnectFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

  WebSocketMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: message.handler
      CodeUri: src/handlers/websocket/
      Description: WebSocket message handler
      Timeout: 60
      Environment:
        Variables:
          TABLE_NAME: !Ref MainTable
          CONNECTIONS_TABLE: !Ref ConnectionsTable
          CHAT_MODEL: "us.anthropic.claude-3-sonnet-20240229-v1:0"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
                - execute-api:Invoke
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/POST/@connections/*"
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource:
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0"
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-sonnet-4-5-20250929-v1:0"
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt WorkflowEventBus.Arn

  WebSocketMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WebSocketMessageFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"

  # ============================================
  # Lambda Functions - Workers
  # ============================================
  AIProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: ai_processor.handler
      CodeUri: src/handlers/workers/
      Description: Processes AI requests from queue
      Timeout: 120
      MemorySize: 512
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource:
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0"
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-haiku-4-5-20251001-v1:0"
                - !Sub "arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-image-generator-v2:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-sonnet-4-5-20250929-v1:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-haiku-4-5-20251001-v1:0"
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AIProcessingQueue.Arn
            BatchSize: 1

  WorkflowTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: workflow_trigger.handler
      CodeUri: src/handlers/workers/
      Description: Handles workflow trigger events from DynamoDB streams and publishes to EventBridge
      Timeout: 60
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref WorkflowEventBus
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt WorkflowEventBus.Arn
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt MainTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 10
            FilterCriteria:
              Filters:
                - Pattern: '{"eventName": ["INSERT", "MODIFY"]}'

  # Workflow Queue Processor - processes events from FIFO queue
  WorkflowQueueProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: workflow_queue_processor.handler
      CodeUri: src/handlers/workers/
      Description: Processes workflow trigger events from FIFO queue with fair multi-tenant ordering
      Timeout: 60
      Environment:
        Variables:
          # Use pattern-based ARN to avoid circular dependency
          WORKFLOW_STATE_MACHINE_ARN: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource:
                - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor"
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowQueue.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures

  WorkflowExecutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: workflow_executor.handler
      CodeUri: src/handlers/workers/
      Description: Executes individual workflow steps
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          # Use pattern-based ARN to avoid circular dependency
          WORKFLOW_STATE_MACHINE_ARN: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor"
          SCHEDULER_ROLE_ARN: !GetAtt SchedulerRole.Arn
          # WebSocket real-time updates
          CONNECTIONS_TABLE: !Ref ConnectionsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ConnectionsTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt AIProcessingQueue.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource:
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0"
                - "arn:aws:bedrock:*::foundation-model/anthropic.claude-haiku-4-5-20251001-v1:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-sonnet-4-5-20250929-v1:0"
                - !Sub "arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/us.anthropic.claude-haiku-4-5-20251001-v1:0"
        - Statement:
            - Effect: Allow
              Action:
                - execute-api:ManageConnections
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*"
        - Statement:
            - Effect: Allow
              Action:
                - scheduler:CreateSchedule
                - scheduler:DeleteSchedule
                - scheduler:GetSchedule
              Resource:
                - !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/wf-resume-*"
        - Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource:
                - !GetAtt SchedulerRole.Arn
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
                - ses:SendTemplatedEmail
              Resource: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*"

  # Sharded Queue Processor - processes events from sharded standard queues
  ShardedQueueProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: sharded_queue_processor.handler
      CodeUri: src/handlers/workers/
      Description: Processes workflow triggers from sharded queues with fair scheduling
      Timeout: 60
      Environment:
        Variables:
          WORKFLOW_STATE_MACHINE_ARN: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor"
          SHARD_COUNT: "4"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource:
                - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor"
      Events:
        Shard0:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowQueueShard0.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures
        Shard1:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowQueueShard1.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures
        Shard2:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowQueueShard2.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures
        Shard3:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowQueueShard3.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures
        Priority:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowPriorityQueue.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures

  # DLQ Handler - automatic remediation of failed messages
  WorkflowDLQHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: dlq_handler.handler
      CodeUri: src/handlers/workers/
      Description: Processes DLQ messages with automatic error remediation
      Timeout: 120
      Environment:
        Variables:
          DLQ_ALERT_TOPIC_ARN: !Ref DLQAlertTopic
          WORKFLOW_QUEUE_URL: !Ref WorkflowQueue
          SHARD_QUEUE_URL_0: !Ref WorkflowQueueShard0
          SHARD_QUEUE_URL_1: !Ref WorkflowQueueShard1
          SHARD_QUEUE_URL_2: !Ref WorkflowQueueShard2
          SHARD_QUEUE_URL_3: !Ref WorkflowQueueShard3
          SHARD_COUNT: "4"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueue.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueueShard0.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueueShard1.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueueShard2.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueueShard3.QueueName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt DLQAlertTopic.TopicName
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/*"
      Events:
        FifoDLQ:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowDeadLetterQueue.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures
        ShardedDLQ:
          Type: SQS
          Properties:
            Queue: !GetAtt ShardedWorkflowDLQ.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures

  # IAM Role for EventBridge Scheduler to start Step Functions
  # Uses pattern-based ARN to avoid circular dependency
  SchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StartStepFunctions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource:
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor"
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor-express"
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # ============================================
  # Lambda Functions - Webhooks
  # ============================================
  TwilioInboundFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: twilio_inbound.handler
      CodeUri: src/handlers/webhooks/
      Description: Handles inbound Twilio SMS/Voice
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueue.QueueName
      Events:
        Sms:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /webhooks/twilio/sms
            Method: POST
            Auth:
              Authorizer: NONE
        Voice:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /webhooks/twilio/voice
            Method: POST
            Auth:
              Authorizer: NONE

  SegmentInboundFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: segment_inbound.handler
      CodeUri: src/handlers/webhooks/
      Description: Handles inbound Segment events (identify, track, etc.)
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueue.QueueName
      Events:
        SegmentWebhook:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /webhooks/segment/{workspace_id}
            Method: POST
            Auth:
              Authorizer: NONE

  # ============================================
  # Stripe Connect API
  # ============================================
  AnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: analytics.handler
      CodeUri: src/handlers/api/
      Description: Analytics and reporting
      Timeout: 60
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        GetAnalytics:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/analytics
            Method: GET

  StripeFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: stripe_connect.handler
      CodeUri: src/handlers/api/
      Description: Stripe Connect OAuth and account management
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        StartConnect:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/stripe/connect/start
            Method: POST
        OAuthCallback:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /stripe/connect/callback
            Method: POST
            Auth:
              Authorizer: NONE
        GetStatus:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/stripe/connect/status
            Method: GET
        Disconnect:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/stripe/connect/disconnect
            Method: POST

  # Stripe Webhook Handler
  StripeWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: stripe_webhook.handler
      CodeUri: src/handlers/webhooks/
      Description: Handles Stripe payment webhooks
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt WorkflowQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/complens-${Stage}-workflow-events"
      Events:
        StripeWebhook:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /webhooks/stripe/{workspace_id}
            Method: POST
            Auth:
              Authorizer: NONE
        StripeWebhookGlobal:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /webhooks/stripe
            Method: POST
            Auth:
              Authorizer: NONE

  # ============================================
  # Workflow Templates
  # ============================================
  WorkflowTemplatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: workflow_templates.handler
      CodeUri: src/handlers/api/
      Description: Workflow templates CRUD
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflow-templates
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflow-templates
            Method: POST
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/workflow-templates/{template_id}
            Method: DELETE

  # ============================================
  # Platform Billing
  # ============================================
  BillingFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: billing.handler
      CodeUri: src/handlers/api/
      Description: Platform billing and subscription management
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Environment:
        Variables:
          STRIPE_BILLING_SECRET_KEY: !Ref StripeBillingSecretKey
          STRIPE_PRO_PRICE_ID: !Ref StripeProPriceId
          STRIPE_BUSINESS_PRICE_ID: !Ref StripeBusinessPriceId
      Events:
        GetBilling:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/billing
            Method: GET
        Checkout:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/billing/checkout
            Method: POST
        Portal:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/billing/portal
            Method: POST

  # ============================================
  # Super Admin Functions
  # ============================================
  AdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "complens-${Stage}-admin"
      Handler: admin.handler
      CodeUri: src/handlers/api/
      Description: Super admin platform management
      Timeout: 30
      Environment:
        Variables:
          COGNITO_USER_POOL_ID: !Ref UserPool
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:ListUsers
                - cognito-idp:AdminGetUser
                - cognito-idp:AdminDisableUser
                - cognito-idp:AdminEnableUser
              Resource: !GetAtt UserPool.Arn
            - Effect: Allow
              Action:
                - cloudwatch:GetMetricData
                - cloudwatch:GetMetricStatistics
                - cloudwatch:ListMetrics
              Resource: "*"
            - Effect: Allow
              Action:
                - sqs:GetQueueAttributes
              Resource:
                - !GetAtt AIProcessingQueue.Arn
                - !GetAtt WorkflowQueue.Arn
            - Effect: Allow
              Action:
                - lambda:ListFunctions
              Resource: "*"
            - Effect: Allow
              Action:
                - states:ListStateMachines
                - states:ListExecutions
              Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-*"
            - Effect: Allow
              Action:
                - ce:GetCostAndUsage
              Resource: "*"
      Events:
        ListWorkspaces:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/workspaces
            Method: GET
        GetWorkspace:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/workspaces/{workspace_id}
            Method: GET
        UpdateWorkspace:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/workspaces/{workspace_id}
            Method: PUT
        ListUsers:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/users
            Method: GET
        GetUser:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/users/{user_id}
            Method: GET
        DisableUser:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/users/{user_id}/disable
            Method: POST
        EnableUser:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/users/{user_id}/enable
            Method: POST
        BillingSummary:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/billing/summary
            Method: GET
        SystemHealth:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/system/health
            Method: GET
        GetWorkspaceStats:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/workspaces/{workspace_id}/stats
            Method: GET
        GetUserStats:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/users/{user_id}/stats
            Method: GET
        GetUsageMetrics:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/costs/usage
            Method: GET
        GetActualCosts:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/costs/actual
            Method: GET
        GetPlatformStats:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /admin/stats/platform
            Method: GET

  BillingWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: billing_webhook.handler
      CodeUri: src/handlers/webhooks/
      Description: Handles Stripe billing events via EventBridge
      Timeout: 30
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Environment:
        Variables:
          STRIPE_PRO_PRICE_ID: !Ref StripeProPriceId
          STRIPE_BUSINESS_PRICE_ID: !Ref StripeBusinessPriceId

  # Stripe EventBridge integration
  # Note: Partner event bus already exists from Stripe, just reference it by name
  StripeBillingEventRule:
    Type: AWS::Events::Rule
    Condition: StripeEventBridgeEnabled
    Properties:
      EventBusName: !Ref StripeEventSourceName
      EventPattern:
        source:
          - prefix: "aws.partner/stripe.com"
        detail-type:
          - "checkout.session.completed"
          - "customer.subscription.created"
          - "customer.subscription.updated"
          - "customer.subscription.deleted"
          - "invoice.payment_failed"
      State: ENABLED
      Targets:
        - Arn: !GetAtt BillingWebhookFunction.Arn
          Id: BillingWebhookTarget

  StripeBillingEventPermission:
    Type: AWS::Lambda::Permission
    Condition: StripeEventBridgeEnabled
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref BillingWebhookFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt StripeBillingEventRule.Arn

  # ============================================
  # Knowledge Base
  # ============================================
  KnowledgeBaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: knowledge_base.handler
      CodeUri: src/handlers/api/
      Description: Knowledge base document management
      Timeout: 60
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - S3CrudPolicy:
            BucketName: !Ref KBDocumentsBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:Retrieve
                - bedrock:InvokeModel
              Resource: "*"
            - Effect: Allow
              Action:
                - bedrock:StartIngestionJob
              Resource: "*"
      Environment:
        Variables:
          KB_DOCUMENTS_BUCKET: !Ref KBDocumentsBucket
          KNOWLEDGE_BASE_ID: !Ref KnowledgeBaseId
          KB_DATA_SOURCE_ID: !Ref KBDataSourceId
      Events:
        ListDocuments:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/knowledge-base/documents
            Method: GET
        CreateDocument:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/knowledge-base/documents
            Method: POST
        DeleteDocument:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/knowledge-base/documents/{document_id}
            Method: DELETE
        Sync:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/knowledge-base/sync
            Method: POST
        Status:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /workspaces/{workspace_id}/knowledge-base/status
            Method: GET

  # S3 Bucket for Knowledge Base documents
  KBDocumentsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "complens-${Stage}-kb-documents"
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: [PUT]
            AllowedOrigins:
              - !If [IsProd, "https://complens.ai", !Sub "https://${DomainName}"]
            MaxAge: 3600

  # ============================================
  # Step Functions - Workflow Executor
  # ============================================
  WorkflowExecutorStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "complens-${Stage}-workflow-executor"
      DefinitionUri: step-functions/workflow-executor.asl.json
      DefinitionSubstitutions:
        WorkflowExecutorFunctionArn: !GetAtt WorkflowExecutorFunction.Arn
        TableName: !Ref MainTable
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref WorkflowExecutorFunction
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
      Tracing:
        Enabled: true
      Type: STANDARD
      Tags:
        Service: complens
        Stage: !Ref Stage

  # Express State Machine for fast, simple workflows (<5 min)
  WorkflowExecutorExpressStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "complens-${Stage}-workflow-executor-express"
      DefinitionUri: step-functions/workflow-executor-express.asl.json
      DefinitionSubstitutions:
        WorkflowExecutorFunctionArn: !GetAtt WorkflowExecutorFunction.Arn
        TableName: !Ref MainTable
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref WorkflowExecutorFunction
        - DynamoDBCrudPolicy:
            TableName: !Ref MainTable
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogDelivery
                - logs:GetLogDelivery
                - logs:UpdateLogDelivery
                - logs:DeleteLogDelivery
                - logs:ListLogDeliveries
                - logs:PutResourcePolicy
                - logs:DescribeResourcePolicies
                - logs:DescribeLogGroups
              Resource: "*"
      Tracing:
        Enabled: true
      Type: EXPRESS
      Logging:
        Level: ERROR
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt ExpressStateMachineLogGroup.Arn
      Tags:
        Service: complens
        Stage: !Ref Stage

  ExpressStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-workflow-executor-express"
      RetentionInDays: !If [IsProd, 30, 7]

  # CloudWatch Log Groups for Lambda functions are auto-created by Lambda.
  # Explicit definitions were removed to avoid ResourceExistenceCheck failures
  # when log groups already exist from previous deployments.
  # To set retention policies, use AWS CLI:
  #   aws logs put-retention-policy --log-group-name /aws/lambda/complens-dev-<fn> --retention-in-days 14

  # ============================================
  # ACM Certificate for Custom Domain
  # ============================================
  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: CreateCertificate
    Properties:
      DomainName: !Sub "*.${DomainName}"
      SubjectAlternativeNames:
        - !Ref DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "*.${DomainName}"
          HostedZoneId: !Ref HostedZoneId
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # ============================================
  # REST API Custom Domain
  # ============================================
  RestApiDomainName:
    Type: AWS::ApiGateway::DomainName
    Condition: CustomDomainEnabled
    Properties:
      DomainName: !Sub "api.${DomainName}"
      RegionalCertificateArn: !If [UseCertificateArn, !Ref CertificateArn, !Ref ApiCertificate]
      EndpointConfiguration:
        Types:
          - REGIONAL
      SecurityPolicy: TLS_1_2
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  RestApiBasePathMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Condition: CustomDomainEnabled
    DependsOn: RestApiDomainName
    Properties:
      DomainName: !Ref RestApiDomainName
      RestApiId: !Ref RestApi
      Stage: !Ref Stage

  # ============================================
  # WebSocket API Custom Domain
  # ============================================
  WebSocketApiDomainName:
    Type: AWS::ApiGatewayV2::DomainName
    Condition: CustomDomainEnabled
    Properties:
      DomainName: !Sub "ws.${DomainName}"
      DomainNameConfigurations:
        - CertificateArn: !If [UseCertificateArn, !Ref CertificateArn, !Ref ApiCertificate]
          EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2
      Tags:
        Service: complens
        Stage: !Ref Stage

  WebSocketApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Condition: CustomDomainEnabled
    DependsOn:
      - WebSocketApiDomainName
      - WebSocketStage
    Properties:
      ApiId: !Ref WebSocketApi
      DomainName: !Ref WebSocketApiDomainName
      Stage: !Ref Stage

  # ============================================
  # Route 53 DNS Records
  # ============================================
  RestApiDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub "api.${DomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt RestApiDomainName.RegionalDomainName
        HostedZoneId: !GetAtt RestApiDomainName.RegionalHostedZoneId
        EvaluateTargetHealth: false

  WebSocketApiDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub "ws.${DomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt WebSocketApiDomainName.RegionalDomainName
        HostedZoneId: !GetAtt WebSocketApiDomainName.RegionalHostedZoneId
        EvaluateTargetHealth: false

  # ============================================
  # S3 Bucket for Frontend Static Hosting
  # ============================================
  FrontendBucket:
    Type: AWS::S3::Bucket
    Condition: CustomDomainEnabled
    Properties:
      BucketName: !Sub "complens-${Stage}-frontend-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - HEAD
            AllowedOrigins:
              - !Sub "https://${DomainName}"
            MaxAge: 3600
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CustomDomainEnabled
    DependsOn: FrontendDistribution
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontAccess
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "${FrontendBucket.Arn}/*"
            Condition:
              StringEquals:
                "AWS:SourceArn": !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${FrontendDistribution}"

  # ============================================
  # S3 Bucket for Generated Assets (Images, etc.)
  # ============================================
  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "complens-${Stage}-assets-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - HEAD
            AllowedOrigins:
              - "*"
            MaxAge: 3600
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  AssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AssetsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: PublicReadAccess
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Sub "${AssetsBucket.Arn}/*"

  # ============================================
  # CloudFront Distribution for Frontend
  # ============================================
  FrontendOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Condition: CustomDomainEnabled
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${AWS::StackName}-frontend-oac"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Function to rewrite /embed/* SPA routes to /index.html.
  # Without this, S3 returns 404 for /embed/chat and the CustomErrorResponse
  # serves /index.html via the default behavior (which has X-Frame-Options).
  EmbedSpaRewriteFunction:
    Type: AWS::CloudFront::Function
    Condition: CustomDomainEnabled
    Properties:
      Name: !Sub "${AWS::StackName}-embed-spa-rewrite"
      AutoPublish: true
      FunctionCode: |
        function handler(event) {
          var request = event.request;
          var uri = request.uri;
          // Pass through actual files (have an extension)
          if (uri.match(/\.\w+$/)) {
            return request;
          }
          // Rewrite SPA routes to index.html
          request.uri = '/index.html';
          return request;
        }
      FunctionConfig:
        Comment: "Rewrite embed SPA routes to index.html"
        Runtime: cloudfront-js-2.0

  # Response headers policy for embeddable content (no X-Frame-Options)
  EmbedResponseHeadersPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Condition: CustomDomainEnabled
    Properties:
      ResponseHeadersPolicyConfig:
        Name: !Sub "${AWS::StackName}-embed-headers"
        SecurityHeadersConfig:
          ContentTypeOptions:
            Override: true
          ReferrerPolicy:
            Override: true
            ReferrerPolicy: strict-origin-when-cross-origin
          StrictTransportSecurity:
            Override: true
            AccessControlMaxAgeSec: 63072000
            IncludeSubdomains: true
            Preload: true
          XSSProtection:
            Override: true
            ModeBlock: true
            Protection: true
          # No FrameOptions  intentionally omitted to allow iframe embedding

  FrontendDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: CustomDomainEnabled
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub "Complens ${Stage} Frontend"
        DefaultRootObject: index.html
        Aliases:
          - !Ref DomainName
        ViewerCertificate:
          AcmCertificateArn: !If [UseCertificateArn, !Ref CertificateArn, !Ref ApiCertificate]
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !GetAtt FrontendOriginAccessControl.Id
        CacheBehaviors:
          # /embed/* paths need to be frameable on external sites
          - PathPattern: /embed/*
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            Compress: true
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
            ResponseHeadersPolicyId: !Ref EmbedResponseHeadersPolicy
            FunctionAssociations:
              - EventType: viewer-request
                FunctionARN: !GetAtt EmbedSpaRewriteFunction.FunctionMetadata.FunctionARN
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03  # SecurityHeadersPolicy
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 10
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 10
        PriceClass: PriceClass_100
        HttpVersion: http2and3
        IPV6Enabled: true
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  FrontendDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt FrontendDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

  FrontendDnsRecordIPv6:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: AAAA
      AliasTarget:
        DNSName: !GetAtt FrontendDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

  # ============================================
  # CloudFront Distribution for Custom Domain Pages
  # ============================================
  # This distribution serves landing pages for custom domains.
  # Customers CNAME their domain to pages.{DomainName} (e.g., pages.dev.complens.ai)
  #
  # How it works:
  # 1. Customer sets custom_domain on their page (e.g., itsross.com)
  # 2. Customer CNAMEs itsross.com  pages.dev.complens.ai
  # 3. CloudFront Function extracts Host header and rewrites URI to /domain/{host}
  # 4. API Gateway Lambda looks up page by domain and returns rendered HTML
  #
  # For true custom domains (not subdomains), manually add to CloudFront:
  # 1. ACM certificate covering the domain (or use existing wildcard if subdomain)
  # 2. Domain as CloudFront Alias via console/CLI

  PagesDomainRouterFunction:
    Type: AWS::CloudFront::Function
    Condition: CustomDomainEnabled
    Properties:
      Name: !Sub "${AWS::StackName}-pages-router"
      AutoPublish: true
      FunctionCode: |
        function handler(event) {
          var request = event.request;
          var host = request.headers.host ? request.headers.host.value : '';

          // Rewrite URI to include the domain for lookup
          // /anything  /{domain}
          // The domain becomes the path for API Gateway routing
          request.uri = '/' + host;

          return request;
        }
      FunctionConfig:
        Comment: "Route requests based on Host header for custom domain pages"
        Runtime: cloudfront-js-2.0

  PagesDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: CustomDomainEnabled
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub "Complens ${Stage} Landing Pages (Custom Domains)"
        Aliases:
          - !Sub "pages.${DomainName}"
        ViewerCertificate:
          AcmCertificateArn: !If [UseCertificateArn, !Ref CertificateArn, !Ref ApiCertificate]
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
          - Id: ApiGatewayOrigin
            DomainName: !Sub "${RestApi}.execute-api.${AWS::Region}.amazonaws.com"
            OriginPath: !Sub "/${Stage}/public/domain"
            CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        DefaultCacheBehavior:
          TargetOriginId: ApiGatewayOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad  # CachingDisabled
          OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac  # AllViewerExceptHostHeader
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03  # SecurityHeadersPolicy
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN: !GetAtt PagesDomainRouterFunction.FunctionMetadata.FunctionARN
        PriceClass: PriceClass_100
        HttpVersion: http2and3
        IPV6Enabled: true
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  PagesDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub "pages.${DomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt PagesDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

  PagesDnsRecordIPv6:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub "pages.${DomainName}"
      Type: AAAA
      AliasTarget:
        DNSName: !GetAtt PagesDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

  # ============================================
  # CloudFront Distribution for Subdomain Pages
  # ============================================
  # This distribution serves landing pages for subdomains like itsross.dev.complens.ai
  #
  # How it works:
  # 1. User claims subdomain "itsross" for their page
  # 2. Wildcard DNS *.dev.complens.ai  this CloudFront distribution
  # 3. CloudFront Function extracts subdomain from Host header
  # 4. Request forwarded to API: /public/subdomain/{subdomain}
  # 5. Lambda renders the page HTML

  SubdomainRouterFunction:
    Type: AWS::CloudFront::Function
    Condition: CustomDomainEnabled
    Properties:
      Name: !Sub "${AWS::StackName}-subdomain-router"
      AutoPublish: true
      FunctionCode: |
        function handler(event) {
          var request = event.request;
          var host = request.headers.host.value;

          // Extract subdomain from host (e.g., "itsross" from "itsross.dev.complens.ai")
          var parts = host.split('.');
          var subdomain = parts[0];

          // Rewrite URI to include subdomain path
          request.uri = '/' + subdomain;

          return request;
        }
      FunctionConfig:
        Comment: !Sub "Route subdomain requests to API for ${Stage}"
        Runtime: cloudfront-js-1.0

  SubdomainDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: CustomDomainEnabled
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub "Complens ${Stage} Subdomain Pages (*.${DomainName})"
        Aliases:
          - !Sub "*.${DomainName}"
        ViewerCertificate:
          AcmCertificateArn: !If [UseCertificateArn, !Ref CertificateArn, !Ref ApiCertificate]
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
          - Id: ApiGatewayOrigin
            DomainName: !Sub "${RestApi}.execute-api.${AWS::Region}.amazonaws.com"
            OriginPath: !Sub "/${Stage}/public/subdomain"
            CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        DefaultCacheBehavior:
          TargetOriginId: ApiGatewayOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf  # CORS-S3Origin
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN: !GetAtt SubdomainRouterFunction.FunctionMetadata.FunctionARN
        PriceClass: PriceClass_100
        HttpVersion: http2and3
      Tags:
        - Key: Service
          Value: complens
        - Key: Stage
          Value: !Ref Stage

  # Wildcard DNS record for subdomains
  SubdomainDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub "*.${DomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt SubdomainDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

  SubdomainDnsRecordIPv6:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Sub "*.${DomainName}"
      Type: AAAA
      AliasTarget:
        DNSName: !GetAtt SubdomainDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID (constant)
        EvaluateTargetHealth: false

Conditions:
  IsProd: !Equals [!Ref Stage, "prod"]
  StripeEventBridgeEnabled: !Not [!Equals [!Ref StripeEventSourceName, ""]]
  CustomDomainEnabled: !Equals [!Ref EnableCustomDomain, "true"]
  CreateCertificate: !And
    - !Equals [!Ref EnableCustomDomain, "true"]
    - !Equals [!Ref CertificateArn, ""]
  UseCertificateArn: !And
    - !Equals [!Ref EnableCustomDomain, "true"]
    - !Not [!Equals [!Ref CertificateArn, ""]]

Outputs:
  RestApiUrl:
    Description: REST API URL
    Value: !Sub "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"
    Export:
      Name: !Sub "${AWS::StackName}-RestApiUrl"

  RestApiCustomUrl:
    Condition: CustomDomainEnabled
    Description: REST API Custom Domain URL
    Value: !Sub "https://api.${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-RestApiCustomUrl"

  WebSocketUrl:
    Description: WebSocket API URL
    Value: !Sub "wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"
    Export:
      Name: !Sub "${AWS::StackName}-WebSocketUrl"

  WebSocketCustomUrl:
    Condition: CustomDomainEnabled
    Description: WebSocket API Custom Domain URL
    Value: !Sub "wss://ws.${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-WebSocketCustomUrl"

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"

  TableName:
    Description: DynamoDB Table Name
    Value: !Ref MainTable
    Export:
      Name: !Sub "${AWS::StackName}-TableName"

  AIQueueUrl:
    Description: AI Processing Queue URL
    Value: !Ref AIProcessingQueue
    Export:
      Name: !Sub "${AWS::StackName}-AIQueueUrl"

  WorkflowQueueUrl:
    Description: Workflow Queue URL
    Value: !Ref WorkflowQueue
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowQueueUrl"

  EventBusArn:
    Description: EventBridge Event Bus ARN
    Value: !GetAtt WorkflowEventBus.Arn
    Export:
      Name: !Sub "${AWS::StackName}-EventBusArn"

  WorkflowStateMachineArn:
    Description: Workflow Executor State Machine ARN
    Value: !Ref WorkflowExecutorStateMachine
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowStateMachineArn"

  WorkflowExpressStateMachineArn:
    Description: Workflow Executor Express State Machine ARN (for fast workflows)
    Value: !Ref WorkflowExecutorExpressStateMachine
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowExpressStateMachineArn"

  FrontendUrl:
    Condition: CustomDomainEnabled
    Description: Frontend URL
    Value: !Sub "https://${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-FrontendUrl"

  FrontendBucketName:
    Condition: CustomDomainEnabled
    Description: Frontend S3 Bucket Name
    Value: !Ref FrontendBucket
    Export:
      Name: !Sub "${AWS::StackName}-FrontendBucketName"

  FrontendDistributionId:
    Condition: CustomDomainEnabled
    Description: CloudFront Distribution ID
    Value: !Ref FrontendDistribution
    Export:
      Name: !Sub "${AWS::StackName}-FrontendDistributionId"

  FrontendDistributionDomainName:
    Condition: CustomDomainEnabled
    Description: CloudFront Distribution Domain Name
    Value: !GetAtt FrontendDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-FrontendDistributionDomainName"

  PagesDistributionId:
    Condition: CustomDomainEnabled
    Description: Pages CloudFront Distribution ID (for custom domain landing pages)
    Value: !Ref PagesDistribution
    Export:
      Name: !Sub "${AWS::StackName}-PagesDistributionId"

  PagesDistributionDomainName:
    Condition: CustomDomainEnabled
    Description: Pages CloudFront Distribution Domain Name (CNAME target for custom domains)
    Value: !GetAtt PagesDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-PagesDistributionDomainName"

  PagesCnameTarget:
    Condition: CustomDomainEnabled
    Description: CNAME target for custom domain pages
    Value: !Sub "pages.${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-PagesCnameTarget"

  SubdomainDistributionId:
    Condition: CustomDomainEnabled
    Description: Subdomain CloudFront Distribution ID (for *.dev.complens.ai)
    Value: !Ref SubdomainDistribution
    Export:
      Name: !Sub "${AWS::StackName}-SubdomainDistributionId"

  SubdomainDistributionDomainName:
    Condition: CustomDomainEnabled
    Description: Subdomain CloudFront Distribution Domain Name
    Value: !GetAtt SubdomainDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-SubdomainDistributionDomainName"

  SubdomainBaseUrl:
    Condition: CustomDomainEnabled
    Description: Base URL pattern for subdomain pages (e.g., yourname.dev.complens.ai)
    Value: !Sub "*.${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-SubdomainBaseUrl"

  # Sharded Queue Outputs
  WorkflowQueueShard0Url:
    Description: Workflow Queue Shard 0 URL
    Value: !Ref WorkflowQueueShard0
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowQueueShard0Url"

  WorkflowQueueShard1Url:
    Description: Workflow Queue Shard 1 URL
    Value: !Ref WorkflowQueueShard1
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowQueueShard1Url"

  WorkflowQueueShard2Url:
    Description: Workflow Queue Shard 2 URL
    Value: !Ref WorkflowQueueShard2
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowQueueShard2Url"

  WorkflowQueueShard3Url:
    Description: Workflow Queue Shard 3 URL
    Value: !Ref WorkflowQueueShard3
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowQueueShard3Url"

  WorkflowPriorityQueueUrl:
    Description: Workflow Priority Queue URL
    Value: !Ref WorkflowPriorityQueue
    Export:
      Name: !Sub "${AWS::StackName}-WorkflowPriorityQueueUrl"

  ShardedWorkflowDLQUrl:
    Description: Sharded Workflow DLQ URL
    Value: !Ref ShardedWorkflowDLQ
    Export:
      Name: !Sub "${AWS::StackName}-ShardedWorkflowDLQUrl"

  DLQAlertTopicArn:
    Description: DLQ Alert SNS Topic ARN
    Value: !Ref DLQAlertTopic
    Export:
      Name: !Sub "${AWS::StackName}-DLQAlertTopicArn"
