AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Complens.ai - AI-Native Marketing Automation Platform
Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - staging
    - prod
    Description: Deployment stage
  DomainName:
    Type: String
    Default: dev.complens.ai
    Description: Base domain name for the API
  HostedZoneId:
    Type: String
    Default: Z02373573N3XBHSZBERY6
    Description: Route 53 hosted zone ID for the domain
  EnableCustomDomain:
    Type: String
    Default: 'false'
    AllowedValues:
    - 'true'
    - 'false'
    Description: Enable custom domain configuration (requires valid hosted zone)
  CertificateArn:
    Type: String
    Default: ''
    Description: Optional existing ACM certificate ARN. If empty, a new certificate
      will be created.
  TwilioAccountSid:
    Type: String
    Default: ''
    Description: Twilio Account SID for SMS integration
  TwilioAuthToken:
    Type: String
    Default: ''
    NoEcho: true
    Description: Twilio Auth Token for SMS integration
  TwilioPhoneNumber:
    Type: String
    Default: ''
    Description: Default Twilio phone number for sending SMS
  SesFromEmail:
    Type: String
    Default: ''
    Description: Default sender email address for SES
  SegmentSharedSecret:
    Type: String
    Default: ''
    NoEcho: true
    Description: Segment webhook shared secret for signature verification
Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    MemorySize: 256
    Tracing: Active
    Architectures:
    - x86_64
    Environment:
      Variables:
        TABLE_NAME:
          Ref: MainTable
        STAGE:
          Ref: Stage
        SERVICE_NAME: complens
        COGNITO_USER_POOL_ID:
          Ref: UserPool
        AI_QUEUE_URL:
          Ref: AIProcessingQueue
        WORKFLOW_QUEUE_URL:
          Ref: WorkflowQueue
        EVENT_BUS_NAME:
          Fn::Sub: complens-${Stage}-workflow-events
        WEBSOCKET_ENDPOINT:
          Fn::Sub: https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}
        CORS_ALLOWED_ORIGIN:
          Fn::If:
          - IsProd
          - https://complens.ai
          - Fn::Sub: https://${DomainName}
        TWILIO_ACCOUNT_SID:
          Ref: TwilioAccountSid
        TWILIO_AUTH_TOKEN:
          Ref: TwilioAuthToken
        TWILIO_PHONE_NUMBER:
          Ref: TwilioPhoneNumber
        SES_FROM_EMAIL:
          Ref: SesFromEmail
        SEGMENT_SHARED_SECRET:
          Ref: SegmentSharedSecret
    Layers:
    - Ref: SharedLayer
    VpcConfig:
      SecurityGroupIds: []
      SubnetIds: []
Resources:
  MainTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: complens-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: PK
        AttributeType: S
      - AttributeName: SK
        AttributeType: S
      - AttributeName: GSI1PK
        AttributeType: S
      - AttributeName: GSI1SK
        AttributeType: S
      - AttributeName: GSI2PK
        AttributeType: S
      - AttributeName: GSI2SK
        AttributeType: S
      KeySchema:
      - AttributeName: PK
        KeyType: HASH
      - AttributeName: SK
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: GSI1
        KeySchema:
        - AttributeName: GSI1PK
          KeyType: HASH
        - AttributeName: GSI1SK
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: GSI2
        KeySchema:
        - AttributeName: GSI2PK
          KeyType: HASH
        - AttributeName: GSI2SK
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  ConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: complens-${Stage}-connections
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: connectionId
        AttributeType: S
      - AttributeName: userId
        AttributeType: S
      KeySchema:
      - AttributeName: connectionId
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: UserIdIndex
        KeySchema:
        - AttributeName: userId
          KeyType: HASH
        Projection:
          ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Sub: complens-${Stage}-users
      AutoVerifiedAttributes:
      - email
      UsernameAttributes:
      - email
      MfaConfiguration: OPTIONAL
      EnabledMfas:
      - SOFTWARE_TOKEN_MFA
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      Schema:
      - Name: agency_id
        AttributeDataType: String
        Mutable: true
      - Name: workspace_ids
        AttributeDataType: String
        Mutable: true
      AccountRecoverySetting:
        RecoveryMechanisms:
        - Name: verified_email
          Priority: 1
      UserPoolTags:
        Service: complens
        Stage:
          Ref: Stage
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName:
        Fn::Sub: complens-${Stage}-web
      UserPoolId:
        Ref: UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      - ALLOW_USER_SRP_AUTH
      PreventUserExistenceErrors: ENABLED
      AccessTokenValidity: 1
      IdTokenValidity: 1
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      SupportedIdentityProviders:
      - COGNITO
  AIProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: complens-${Stage}-ai-queue
      VisibilityTimeout: 120
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - AIDeadLetterQueue
          - Arn
        maxReceiveCount: 3
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  AIDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: complens-${Stage}-ai-dlq
      MessageRetentionPeriod: 1209600
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  WorkflowQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: complens-${Stage}-workflow-queue.fifo
      FifoQueue: true
      ContentBasedDeduplication: false
      DeduplicationScope: messageGroup
      FifoThroughputLimit: perMessageGroupId
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - WorkflowDeadLetterQueue
          - Arn
        maxReceiveCount: 3
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  WorkflowDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: complens-${Stage}-workflow-dlq.fifo
      FifoQueue: true
      ContentBasedDeduplication: false
      MessageRetentionPeriod: 1209600
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  WorkflowEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-workflow-events
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  TagTriggerRule:
    Type: AWS::Events::Rule
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-tag-trigger
      EventBusName:
        Ref: WorkflowEventBus
      EventPattern:
        source:
        - complens.contact
        detail-type:
        - contact.tag.added
        - contact.tag.removed
      State: ENABLED
      Targets:
      - Id: WorkflowTriggerQueue
        Arn:
          Fn::GetAtt:
          - WorkflowQueue
          - Arn
        SqsParameters:
          MessageGroupId: $.detail.workspace_id
  FormSubmitRule:
    Type: AWS::Events::Rule
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-form-submit-trigger
      EventBusName:
        Ref: WorkflowEventBus
      EventPattern:
        source:
        - complens.form
        detail-type:
        - form.submitted
      State: ENABLED
      Targets:
      - Id: WorkflowTriggerQueue
        Arn:
          Fn::GetAtt:
          - WorkflowQueue
          - Arn
        SqsParameters:
          MessageGroupId: $.detail.workspace_id
  InboundMessageRule:
    Type: AWS::Events::Rule
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-inbound-message-trigger
      EventBusName:
        Ref: WorkflowEventBus
      EventPattern:
        source:
        - complens.messaging
        detail-type:
        - sms.inbound
        - email.inbound
      State: ENABLED
      Targets:
      - Id: WorkflowTriggerQueue
        Arn:
          Fn::GetAtt:
          - WorkflowQueue
          - Arn
        SqsParameters:
          MessageGroupId: $.detail.workspace_id
  WorkflowQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
      - Ref: WorkflowQueue
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Action: sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - WorkflowQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
              - Fn::GetAtt:
                - TagTriggerRule
                - Arn
              - Fn::GetAtt:
                - FormSubmitRule
                - Arn
              - Fn::GetAtt:
                - InboundMessageRule
                - Arn
  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName:
        Fn::Sub: complens-${Stage}-shared
      Description: Shared code for Complens Lambda functions
      ContentUri: ../../src/layers/shared
      CompatibleRuntimes:
      - python3.12
      CompatibleArchitectures:
      - x86_64
      RetentionPolicy: Retain
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-api
      StageName:
        Ref: Stage
      TracingEnabled: true
      Cors:
        AllowMethods: '''GET,POST,PUT,PATCH,DELETE,OPTIONS'''
        AllowHeaders: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token,X-Requested-With'''
        AllowOrigin:
          Fn::If:
          - IsProd
          - '''https://complens.ai'''
          - Fn::Sub: '''https://${DomainName}'''
        AllowCredentials: true
        MaxAge: '''600'''
      Auth:
        DefaultAuthorizer: JwtAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          JwtAuthorizer:
            FunctionArn:
              Fn::GetAtt:
              - JwtAuthorizerFunction
              - Arn
            FunctionPayloadType: REQUEST
            Identity:
              Headers:
              - Authorization
              ReauthorizeEvery: 300
      GatewayResponses:
        DEFAULT_4XX:
          StatusCode: 400
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin:
                Fn::If:
                - IsProd
                - '''https://complens.ai'''
                - Fn::Sub: '''https://${DomainName}'''
              Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
          ResponseTemplates:
            application/json: '{"message": "$context.error.messageString"}'
        DEFAULT_5XX:
          StatusCode: 500
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin:
                Fn::If:
                - IsProd
                - '''https://complens.ai'''
                - Fn::Sub: '''https://${DomainName}'''
              Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
          ResponseTemplates:
            application/json: '{"message": "Internal server error"}'
        UNAUTHORIZED:
          StatusCode: 401
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin:
                Fn::If:
                - IsProd
                - '''https://complens.ai'''
                - Fn::Sub: '''https://${DomainName}'''
              Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
              Access-Control-Allow-Methods: '''GET,POST,PUT,PATCH,DELETE,OPTIONS'''
          ResponseTemplates:
            application/json: '{"message": "Unauthorized"}'
        ACCESS_DENIED:
          StatusCode: 403
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin:
                Fn::If:
                - IsProd
                - '''https://complens.ai'''
                - Fn::Sub: '''https://${DomainName}'''
              Access-Control-Allow-Headers: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
              Access-Control-Allow-Methods: '''GET,POST,PUT,PATCH,DELETE,OPTIONS'''
          ResponseTemplates:
            application/json: '{"message": "Access denied"}'
      MethodSettings:
      - ResourcePath: /*
        HttpMethod: '*'
        ThrottlingBurstLimit:
          Fn::If:
          - IsProd
          - 200
          - 50
        ThrottlingRateLimit:
          Fn::If:
          - IsProd
          - 100
          - 25
        MetricsEnabled: true
  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-websocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: $request.body.action
      Tags:
        Service: complens
        Stage:
          Ref: Stage
  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId:
        Ref: WebSocketApi
      StageName:
        Ref: Stage
      AutoDeploy: true
  WebSocketConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      OperationName: Connect
      Target:
        Fn::Sub: integrations/${WebSocketConnectIntegration}
  WebSocketConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations
  WebSocketDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      OperationName: Disconnect
      Target:
        Fn::Sub: integrations/${WebSocketDisconnectIntegration}
  WebSocketDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations
  WebSocketMessageRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: WebSocketApi
      RouteKey: message
      AuthorizationType: NONE
      OperationName: Message
      Target:
        Fn::Sub: integrations/${WebSocketMessageIntegration}
  WebSocketMessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketMessageFunction.Arn}/invocations
  WebSocketDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: WebSocketApi
      RouteKey: $default
      AuthorizationType: NONE
      OperationName: Default
      Target:
        Fn::Sub: integrations/${WebSocketMessageIntegration}
  JwtAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-jwt-authorizer
      Handler: jwt_authorizer.handler
      CodeUri: JwtAuthorizerFunction
      Description: JWT token validation for API Gateway
      Environment:
        Variables:
          COGNITO_USER_POOL_ID:
            Ref: UserPool
          COGNITO_REGION:
            Ref: AWS::Region
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:GetUser
          Resource:
            Fn::GetAtt:
            - UserPool
            - Arn
    Metadata:
      SamResourceId: JwtAuthorizerFunction
  JwtAuthorizerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: JwtAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*
  WorkspacesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-workspaces
      Handler: workspaces.handler
      CodeUri: WorkspacesFunction
      Description: Workspaces CRUD operations
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}
            Method: DELETE
    Metadata:
      SamResourceId: WorkspacesFunction
  ContactsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-contacts
      Handler: contacts.handler
      CodeUri: ContactsFunction
      Description: Contacts CRUD operations
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}
            Method: DELETE
    Metadata:
      SamResourceId: ContactsFunction
  ConversationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-conversations
      Handler: conversations.handler
      CodeUri: ConversationsFunction
      Description: Conversations CRUD operations
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      Events:
        ListByWorkspace:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/conversations
            Method: GET
        ListByContact:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/conversations
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/contacts/{contact_id}/conversations
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /conversations/{conversation_id}
            Method: GET
    Metadata:
      SamResourceId: ConversationsFunction
  MessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-messages
      Handler: messages.handler
      CodeUri: MessagesFunction
      Description: Messages CRUD operations
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - AIProcessingQueue
            - QueueName
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /conversations/{conversation_id}/messages
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /conversations/{conversation_id}/messages
            Method: POST
    Metadata:
      SamResourceId: MessagesFunction
  WorkflowsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-workflows
      Handler: workflows.handler
      CodeUri: WorkflowsFunction
      Description: Workflows CRUD and execution
      Timeout: 60
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - WorkflowQueue
            - QueueName
      - StepFunctionsExecutionPolicy:
          StateMachineName:
            Fn::GetAtt:
            - WorkflowExecutorStateMachine
            - Name
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}
            Method: DELETE
        Execute:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}/execute
            Method: POST
        Runs:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/workflows/{workflow_id}/runs
            Method: GET
    Metadata:
      SamResourceId: WorkflowsFunction
  PagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-pages
      Handler: pages.handler
      CodeUri: PagesFunction
      Description: Pages CRUD operations with AI generation
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          ASSETS_BUCKET:
            Ref: AssetsBucket
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - S3CrudPolicy:
          BucketName:
            Ref: AssetsBucket
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/pages
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/pages
            Method: POST
        Generate:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/pages/generate
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/pages/{page_id}
            Method: DELETE
    Metadata:
      SamResourceId: PagesFunction
  FormsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-forms
      Handler: forms.handler
      CodeUri: FormsFunction
      Description: Forms CRUD operations
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/forms
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/forms
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}
            Method: DELETE
        Submissions:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/forms/{form_id}/submissions
            Method: GET
    Metadata:
      SamResourceId: FormsFunction
  DomainsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-domains
      Handler: domains.handler
      CodeUri: DomainsFunction
      Description: Custom domain management
      Timeout: 60
      Environment:
        Variables:
          MAX_DOMAINS_PER_WORKSPACE: '1'
          DOMAIN_PROVISIONING_STATE_MACHINE_ARN:
            Fn::If:
            - CustomDomainEnabled
            - Ref: DomainProvisioningStateMachine
            - ''
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - Statement:
        - Effect: Allow
          Action:
          - acm:RequestCertificate
          - acm:DescribeCertificate
          - acm:DeleteCertificate
          - acm:AddTagsToCertificate
          Resource: '*'
        - Effect: Allow
          Action:
          - cloudfront:GetDistribution
          - cloudfront:UpdateDistribution
          Resource: '*'
        - Effect: Allow
          Action:
          - states:StartExecution
          Resource:
            Fn::If:
            - CustomDomainEnabled
            - Ref: DomainProvisioningStateMachine
            - Fn::Sub: arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:*
      Events:
        List:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/domains
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/domains
            Method: POST
        GetStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/domains/{domain}
            Method: GET
        Delete:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /workspaces/{workspace_id}/domains/{domain}
            Method: DELETE
    Metadata:
      SamResourceId: DomainsFunction
  DomainProvisionerFunction:
    Type: AWS::Serverless::Function
    Condition: CustomDomainEnabled
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-domain-provisioner
      Handler: domain_provisioner.handler
      CodeUri: DomainProvisionerFunction
      Description: Domain provisioning worker for Step Functions
      Timeout: 120
      Environment:
        Variables:
          API_GATEWAY_DOMAIN:
            Fn::Sub: api.${DomainName}
          STAGE:
            Ref: Stage
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - Statement:
        - Effect: Allow
          Action:
          - acm:DescribeCertificate
          Resource: '*'
        - Effect: Allow
          Action:
          - cloudfront:CreateDistribution
          - cloudfront:GetDistribution
          - cloudfront:UpdateDistribution
          - cloudfront:DeleteDistribution
          - cloudfront:TagResource
          Resource: '*'
    Metadata:
      SamResourceId: DomainProvisionerFunction
  DomainProvisioningStateMachine:
    Type: AWS::Serverless::StateMachine
    Condition: CustomDomainEnabled
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-domain-provisioning
      DefinitionUri: ../../step-functions/domain-provisioning.asl.json
      DefinitionSubstitutions:
        DomainProvisionerFunctionArn:
          Fn::GetAtt:
          - DomainProvisionerFunction
          - Arn
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: DomainProvisionerFunction
      Tags:
        Service: complens
        Stage:
          Ref: Stage
  PublicPagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-public-pages
      Handler: public_pages.handler
      CodeUri: PublicPagesFunction
      Description: Public pages and form submissions (no auth)
      Environment:
        Variables:
          API_URL:
            Fn::If:
            - CustomDomainEnabled
            - Fn::Sub: https://api.${DomainName}
            - Fn::Sub: https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - Statement:
        - Effect: Allow
          Action:
          - events:PutEvents
          Resource:
            Fn::GetAtt:
            - WorkflowEventBus
            - Arn
      Events:
        GetPage:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /public/pages/{slug}
            Method: GET
            Auth:
              Authorizer: NONE
        GetForm:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /public/forms/{form_id}
            Method: GET
            Auth:
              Authorizer: NONE
        SubmitPageForm:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /public/submit/page/{page_id}
            Method: POST
            Auth:
              Authorizer: NONE
        SubmitForm:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /public/submit/form/{form_id}
            Method: POST
            Auth:
              Authorizer: NONE
        GetPageByDomain:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /public/domain/{domain}
            Method: GET
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: PublicPagesFunction
  WebSocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-ws-connect
      Handler: connect.handler
      CodeUri: WebSocketConnectFunction
      Description: WebSocket connection handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConnectionsTable
    Metadata:
      SamResourceId: WebSocketConnectFunction
  WebSocketConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: WebSocketConnectFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
  WebSocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-ws-disconnect
      Handler: disconnect.handler
      CodeUri: WebSocketDisconnectFunction
      Description: WebSocket disconnection handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConnectionsTable
    Metadata:
      SamResourceId: WebSocketDisconnectFunction
  WebSocketDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: WebSocketDisconnectFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
  WebSocketMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-ws-message
      Handler: message.handler
      CodeUri: WebSocketMessageFunction
      Description: WebSocket message handler
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME:
            Ref: MainTable
          CONNECTIONS_TABLE:
            Ref: ConnectionsTable
          CHAT_MODEL: us.anthropic.claude-3-sonnet-20240229-v1:0
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConnectionsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - Statement:
        - Effect: Allow
          Action:
          - execute-api:ManageConnections
          Resource:
          - Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - events:PutEvents
          Resource: '*'
    Metadata:
      SamResourceId: WebSocketMessageFunction
  WebSocketMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: WebSocketMessageFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
  AIProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-ai-processor
      Handler: ai_processor.handler
      CodeUri: AIProcessorFunction
      Description: Processes AI requests from queue
      Timeout: 120
      MemorySize: 512
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConnectionsTable
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - execute-api:ManageConnections
          Resource:
          - Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - AIProcessingQueue
              - Arn
            BatchSize: 1
    Metadata:
      SamResourceId: AIProcessorFunction
  WorkflowTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-workflow-trigger
      Handler: workflow_trigger.handler
      CodeUri: WorkflowTriggerFunction
      Description: Handles workflow trigger events from DynamoDB streams and publishes
        to EventBridge
      Timeout: 60
      Environment:
        Variables:
          EVENT_BUS_NAME:
            Ref: WorkflowEventBus
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - Statement:
        - Effect: Allow
          Action:
          - events:PutEvents
          Resource:
            Fn::GetAtt:
            - WorkflowEventBus
            - Arn
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream:
              Fn::GetAtt:
              - MainTable
              - StreamArn
            StartingPosition: LATEST
            BatchSize: 10
            FilterCriteria:
              Filters:
              - Pattern: '{"eventName": ["INSERT", "MODIFY"]}'
    Metadata:
      SamResourceId: WorkflowTriggerFunction
  WorkflowQueueProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-workflow-queue-processor
      Handler: workflow_queue_processor.handler
      CodeUri: WorkflowQueueProcessorFunction
      Description: Processes workflow trigger events from FIFO queue with fair multi-tenant
        ordering
      Timeout: 60
      Environment:
        Variables:
          WORKFLOW_STATE_MACHINE_ARN:
            Fn::Sub: arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - Statement:
        - Effect: Allow
          Action:
          - states:StartExecution
          Resource:
          - Fn::Sub: arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - WorkflowQueue
              - Arn
            BatchSize: 10
            FunctionResponseTypes:
            - ReportBatchItemFailures
    Metadata:
      SamResourceId: WorkflowQueueProcessorFunction
  WorkflowExecutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-workflow-executor
      Handler: workflow_executor.handler
      CodeUri: WorkflowExecutorFunction
      Description: Executes individual workflow steps
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          WORKFLOW_STATE_MACHINE_ARN:
            Fn::Sub: arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor
          SCHEDULER_ROLE_ARN:
            Fn::GetAtt:
            - SchedulerRole
            - Arn
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ConnectionsTable
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - AIProcessingQueue
            - QueueName
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - WorkflowQueue
            - QueueName
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - execute-api:ManageConnections
          Resource:
          - Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*
      - Statement:
        - Effect: Allow
          Action:
          - scheduler:CreateSchedule
          - scheduler:DeleteSchedule
          - scheduler:GetSchedule
          Resource:
          - Fn::Sub: arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/wf-resume-*
      - Statement:
        - Effect: Allow
          Action:
          - iam:PassRole
          Resource:
          - Fn::GetAtt:
            - SchedulerRole
            - Arn
      - Statement:
        - Effect: Allow
          Action:
          - ses:SendEmail
          - ses:SendRawEmail
          - ses:SendTemplatedEmail
          Resource: '*'
    Metadata:
      SamResourceId: WorkflowExecutorFunction
  SchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: complens-${Stage}-scheduler-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: scheduler.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: StartStepFunctions
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - states:StartExecution
            Resource:
            - Fn::Sub: arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:complens-${Stage}-workflow-executor
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  TwilioInboundFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-twilio-inbound
      Handler: twilio_inbound.handler
      CodeUri: TwilioInboundFunction
      Description: Handles inbound Twilio SMS/Voice
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - WorkflowQueue
            - QueueName
      Events:
        Sms:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /webhooks/twilio/sms
            Method: POST
            Auth:
              Authorizer: NONE
        Voice:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /webhooks/twilio/voice
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: TwilioInboundFunction
  SegmentInboundFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: complens-${Stage}-segment-inbound
      Handler: segment_inbound.handler
      CodeUri: SegmentInboundFunction
      Description: Handles inbound Segment events (identify, track, etc.)
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      - SQSSendMessagePolicy:
          QueueName:
            Fn::GetAtt:
            - WorkflowQueue
            - QueueName
      Events:
        SegmentWebhook:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /webhooks/segment/{workspace_id}
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: SegmentInboundFunction
  WorkflowExecutorStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-workflow-executor
      DefinitionUri: ../../step-functions/workflow-executor.asl.json
      DefinitionSubstitutions:
        WorkflowExecutorFunctionArn:
          Fn::GetAtt:
          - WorkflowExecutorFunction
          - Arn
        TableName:
          Ref: MainTable
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: WorkflowExecutorFunction
      - DynamoDBCrudPolicy:
          TableName:
            Ref: MainTable
      Tracing:
        Enabled: true
      Type: STANDARD
      Tags:
        Service: complens
        Stage:
          Ref: Stage
  JwtAuthorizerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-jwt-authorizer
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  WorkspacesLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-workspaces
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  ContactsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-contacts
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  ConversationsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-conversations
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  MessagesLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-messages
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  WorkflowsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-workflows
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  AIProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-ai-processor
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  WorkflowExecutorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-workflow-executor
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  WorkflowQueueProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-workflow-queue-processor
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  WorkflowTriggerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-workflow-trigger
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  PagesLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-pages
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  FormsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-forms
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  PublicPagesLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/complens-${Stage}-public-pages
      RetentionInDays:
        Fn::If:
        - IsProd
        - 90
        - 14
  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: CreateCertificate
    Properties:
      DomainName:
        Fn::Sub: '*.${DomainName}'
      SubjectAlternativeNames:
      - Ref: DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
      - DomainName:
          Fn::Sub: '*.${DomainName}'
        HostedZoneId:
          Ref: HostedZoneId
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  RestApiDomainName:
    Type: AWS::ApiGateway::DomainName
    Condition: CustomDomainEnabled
    Properties:
      DomainName:
        Fn::Sub: api.${DomainName}
      RegionalCertificateArn:
        Fn::If:
        - UseCertificateArn
        - Ref: CertificateArn
        - Ref: ApiCertificate
      EndpointConfiguration:
        Types:
        - REGIONAL
      SecurityPolicy: TLS_1_2
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  RestApiBasePathMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Condition: CustomDomainEnabled
    DependsOn: RestApiDomainName
    Properties:
      DomainName:
        Ref: RestApiDomainName
      RestApiId:
        Ref: RestApi
      Stage:
        Ref: Stage
  WebSocketApiDomainName:
    Type: AWS::ApiGatewayV2::DomainName
    Condition: CustomDomainEnabled
    Properties:
      DomainName:
        Fn::Sub: ws.${DomainName}
      DomainNameConfigurations:
      - CertificateArn:
          Fn::If:
          - UseCertificateArn
          - Ref: CertificateArn
          - Ref: ApiCertificate
        EndpointType: REGIONAL
        SecurityPolicy: TLS_1_2
      Tags:
        Service: complens
        Stage:
          Ref: Stage
  WebSocketApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Condition: CustomDomainEnabled
    DependsOn:
    - WebSocketApiDomainName
    - WebSocketStage
    Properties:
      ApiId:
        Ref: WebSocketApi
      DomainName:
        Ref: WebSocketApiDomainName
      Stage:
        Ref: Stage
  RestApiDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Fn::Sub: api.${DomainName}
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - RestApiDomainName
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - RestApiDomainName
          - RegionalHostedZoneId
        EvaluateTargetHealth: false
  WebSocketApiDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Fn::Sub: ws.${DomainName}
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - WebSocketApiDomainName
          - RegionalDomainName
        HostedZoneId:
          Fn::GetAtt:
          - WebSocketApiDomainName
          - RegionalHostedZoneId
        EvaluateTargetHealth: false
  FrontendBucket:
    Type: AWS::S3::Bucket
    Condition: CustomDomainEnabled
    Properties:
      BucketName:
        Fn::Sub: complens-${Stage}-frontend-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - HEAD
          AllowedOrigins:
          - Fn::Sub: https://${DomainName}
          MaxAge: 3600
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CustomDomainEnabled
    DependsOn: FrontendDistribution
    Properties:
      Bucket:
        Ref: FrontendBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AllowCloudFrontAccess
          Effect: Allow
          Principal:
            Service: cloudfront.amazonaws.com
          Action: s3:GetObject
          Resource:
            Fn::Sub: ${FrontendBucket.Arn}/*
          Condition:
            StringEquals:
              AWS:SourceArn:
                Fn::Sub: arn:aws:cloudfront::${AWS::AccountId}:distribution/${FrontendDistribution}
  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: complens-${Stage}-assets-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - HEAD
          AllowedOrigins:
          - '*'
          MaxAge: 3600
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  AssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: AssetsBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: PublicReadAccess
          Effect: Allow
          Principal: '*'
          Action: s3:GetObject
          Resource:
            Fn::Sub: ${AssetsBucket.Arn}/*
  FrontendOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Condition: CustomDomainEnabled
    Properties:
      OriginAccessControlConfig:
        Name:
          Fn::Sub: complens-${Stage}-frontend-oac
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4
  FrontendDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: CustomDomainEnabled
    Properties:
      DistributionConfig:
        Enabled: true
        Comment:
          Fn::Sub: Complens ${Stage} Frontend
        DefaultRootObject: index.html
        Aliases:
        - Ref: DomainName
        ViewerCertificate:
          AcmCertificateArn:
            Fn::If:
            - UseCertificateArn
            - Ref: CertificateArn
            - Ref: ApiCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
        - Id: S3Origin
          DomainName:
            Fn::GetAtt:
            - FrontendBucket
            - RegionalDomainName
          S3OriginConfig:
            OriginAccessIdentity: ''
          OriginAccessControlId:
            Fn::GetAtt:
            - FrontendOriginAccessControl
            - Id
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachedMethods:
          - GET
          - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03
        CustomErrorResponses:
        - ErrorCode: 403
          ResponseCode: 200
          ResponsePagePath: /index.html
          ErrorCachingMinTTL: 10
        - ErrorCode: 404
          ResponseCode: 200
          ResponsePagePath: /index.html
          ErrorCachingMinTTL: 10
        PriceClass: PriceClass_100
        HttpVersion: http2and3
        IPV6Enabled: true
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  FrontendDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Ref: DomainName
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - FrontendDistribution
          - DomainName
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false
  FrontendDnsRecordIPv6:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Ref: DomainName
      Type: AAAA
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - FrontendDistribution
          - DomainName
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false
  PagesDomainRouterFunction:
    Type: AWS::CloudFront::Function
    Condition: CustomDomainEnabled
    Properties:
      Name:
        Fn::Sub: complens-${Stage}-pages-router
      AutoPublish: true
      FunctionCode: "function handler(event) {\n  var request = event.request;\n \
        \ var host = request.headers.host ? request.headers.host.value : '';\n\n \
        \ // Rewrite URI to include the domain for lookup\n  // /anything \u2192 /{domain}\n\
        \  // The domain becomes the path for API Gateway routing\n  request.uri =\
        \ '/' + host;\n\n  return request;\n}\n"
      FunctionConfig:
        Comment: Route requests based on Host header for custom domain pages
        Runtime: cloudfront-js-2.0
  PagesDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: CustomDomainEnabled
    Properties:
      DistributionConfig:
        Enabled: true
        Comment:
          Fn::Sub: Complens ${Stage} Landing Pages (Custom Domains)
        Aliases:
        - Fn::Sub: pages.${DomainName}
        ViewerCertificate:
          AcmCertificateArn:
            Fn::If:
            - UseCertificateArn
            - Ref: CertificateArn
            - Ref: ApiCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Origins:
        - Id: ApiGatewayOrigin
          DomainName:
            Fn::Sub: ${RestApi}.execute-api.${AWS::Region}.amazonaws.com
          OriginPath:
            Fn::Sub: /${Stage}/public/domain
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
            - TLSv1.2
        DefaultCacheBehavior:
          TargetOriginId: ApiGatewayOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachedMethods:
          - GET
          - HEAD
          Compress: true
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03
          FunctionAssociations:
          - EventType: viewer-request
            FunctionARN:
              Fn::GetAtt:
              - PagesDomainRouterFunction
              - FunctionMetadata.FunctionARN
        PriceClass: PriceClass_100
        HttpVersion: http2and3
        IPV6Enabled: true
      Tags:
      - Key: Service
        Value: complens
      - Key: Stage
        Value:
          Ref: Stage
  PagesDnsRecord:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Fn::Sub: pages.${DomainName}
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - PagesDistribution
          - DomainName
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false
  PagesDnsRecordIPv6:
    Type: AWS::Route53::RecordSet
    Condition: CustomDomainEnabled
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Fn::Sub: pages.${DomainName}
      Type: AAAA
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - PagesDistribution
          - DomainName
        HostedZoneId: Z2FDTNDATAQYW2
        EvaluateTargetHealth: false
Conditions:
  IsProd:
    Fn::Equals:
    - Ref: Stage
    - prod
  CustomDomainEnabled:
    Fn::Equals:
    - Ref: EnableCustomDomain
    - 'true'
  CreateCertificate:
    Fn::And:
    - Fn::Equals:
      - Ref: EnableCustomDomain
      - 'true'
    - Fn::Equals:
      - Ref: CertificateArn
      - ''
  UseCertificateArn:
    Fn::And:
    - Fn::Equals:
      - Ref: EnableCustomDomain
      - 'true'
    - Fn::Not:
      - Fn::Equals:
        - Ref: CertificateArn
        - ''
Outputs:
  RestApiUrl:
    Description: REST API URL
    Value:
      Fn::Sub: https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-RestApiUrl
  RestApiCustomUrl:
    Condition: CustomDomainEnabled
    Description: REST API Custom Domain URL
    Value:
      Fn::Sub: https://api.${DomainName}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-RestApiCustomUrl
  WebSocketUrl:
    Description: WebSocket API URL
    Value:
      Fn::Sub: wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WebSocketUrl
  WebSocketCustomUrl:
    Condition: CustomDomainEnabled
    Description: WebSocket API Custom Domain URL
    Value:
      Fn::Sub: wss://ws.${DomainName}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WebSocketCustomUrl
  UserPoolId:
    Description: Cognito User Pool ID
    Value:
      Ref: UserPool
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-UserPoolId
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value:
      Ref: UserPoolClient
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-UserPoolClientId
  TableName:
    Description: DynamoDB Table Name
    Value:
      Ref: MainTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-TableName
  AIQueueUrl:
    Description: AI Processing Queue URL
    Value:
      Ref: AIProcessingQueue
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-AIQueueUrl
  WorkflowQueueUrl:
    Description: Workflow Queue URL
    Value:
      Ref: WorkflowQueue
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WorkflowQueueUrl
  EventBusArn:
    Description: EventBridge Event Bus ARN
    Value:
      Fn::GetAtt:
      - WorkflowEventBus
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-EventBusArn
  WorkflowStateMachineArn:
    Description: Workflow Executor State Machine ARN
    Value:
      Ref: WorkflowExecutorStateMachine
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WorkflowStateMachineArn
  FrontendUrl:
    Condition: CustomDomainEnabled
    Description: Frontend URL
    Value:
      Fn::Sub: https://${DomainName}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-FrontendUrl
  FrontendBucketName:
    Condition: CustomDomainEnabled
    Description: Frontend S3 Bucket Name
    Value:
      Ref: FrontendBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-FrontendBucketName
  FrontendDistributionId:
    Condition: CustomDomainEnabled
    Description: CloudFront Distribution ID
    Value:
      Ref: FrontendDistribution
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-FrontendDistributionId
  FrontendDistributionDomainName:
    Condition: CustomDomainEnabled
    Description: CloudFront Distribution Domain Name
    Value:
      Fn::GetAtt:
      - FrontendDistribution
      - DomainName
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-FrontendDistributionDomainName
  PagesDistributionId:
    Condition: CustomDomainEnabled
    Description: Pages CloudFront Distribution ID (for custom domain landing pages)
    Value:
      Ref: PagesDistribution
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PagesDistributionId
  PagesDistributionDomainName:
    Condition: CustomDomainEnabled
    Description: Pages CloudFront Distribution Domain Name (CNAME target for custom
      domains)
    Value:
      Fn::GetAtt:
      - PagesDistribution
      - DomainName
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PagesDistributionDomainName
  PagesCnameTarget:
    Condition: CustomDomainEnabled
    Description: CNAME target for custom domain pages
    Value:
      Fn::Sub: pages.${DomainName}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PagesCnameTarget
